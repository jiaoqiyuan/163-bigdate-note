# Hbase 存储模式

## 行存储与列存储

比如有一个表：

| RowID | Date Time | Meterial | Quantity |
|:-----:|:---------:|:--------:|:--------:|
| 1 | 845 | 2 | 3 |
| 2 | 846 | 5 | 2 | 
| 3 | 847 | 4 | 4 | 
| 4 | 848 | 1 | 5 |

行式存储的话就是按行储存数据，每行数据的每个字段连续存储，上面的这个表按行存储下来就是：

```
| 1 | 845 | 2 | 3 | ---> | 2 | 846 | 5 | 2 | ---> | 3 | 847 | 4 | 4 | ---> | 4 | 848 | 1 | 5 |
```

列式存储是指数据以列为单位进行存储，每列数据连续存储，上面的表按列式存储的话就是：

```
| 1 | 2 | 3 | 4 | ---> | 845 | 846 | 847 | 848 | ---> | 2 | 5 | 4 | 1 | ---> | 3 | 2 | 4 | 5 |
```

### 行存储与列存储的特点

行式存储维护大量所以，存储成本高，不能大量扩展，但是随机读的效率很高，而且对事物的处理能力支持地特别好。另外数据的插入和更新比较方便。

列式存储便于对相同类型的列数据进行压缩，存储成本低；由于列式存储是将不同的列分开存储，所以可以并行高效的查询不同的列。


### 行式存储和列式存储的应用环境

使用列式存储的场景：

- 对于单列或者少部分列获取比较频繁的情况下可以采用列存储的方式；

- 如果针对多列并行查询，也可以考虑使用列式存储。

- 对于大数据场景，数据压缩和线性扩展这些需求比较高的情况下可以考虑使用列存储。

- 事物使用率不高，随机读取的场景不多，同时数据量非常大，随机更新某些行的频率不高

使用行式存储的场景：

- 表与表关系比较紧密，且数据量不大。可以使用外键实现表与表之间的关联

- 联机事物处理能力强，对于事物处理要求较高，比如消费的数据记录

- 数据量小于亿的量级，在千万量级的情况下可以考虑行式存储。

总之，列式存储更适合OLAP（联机事物分析）型应用，行式存储更适合OLTP（联机事物处理）型应用。

## Hbase 的列族式存储

### 什么是列族式存储

列族就是指多个列的组合，Hbase表中的每个列都归属于某个列族，列族是表的 schema 的一部分，但是列并不是，在创建一张表时需要给出列族的名称但是不需要给出列的名称。

列明都是以列族作为前缀的，访问控制、磁盘和内存的使用统计都是在列族层面进行的，Hbase准确地说应该是列族数据库而不是列数据库，列族数据库将列组织为列族，每一列都必须是某个列族的一部分，而且访问数据的单元也要是列，这样设计的前提是某个列族中的所有列是经常需要被访问的，这样才会使得数据的存储是最优的。

### Hbase Table 组成

> Table = RowKey(行键) + Family(列族) + Column(列) + TimeStamp(时间戳/版本) + Value

数据存储模式(Key-value):

> (Table, RowKey, Family, Column, TimeStamp) -> Value

```
SortedMap<RowKey, List<SortedMap<Column, List<Value, TimeStamp>>>>
```

Hbase 数据存储原型是按照RowKey在字典中的顺序排序，在相同RowKey的情况下根据列族进行排序。

## Hbase 存储示例

比如有一个示例表 `test` ：

| table name | column family | columns |
|:----------:|:-------------:|:-------:|
| test | cf | a, b, c, day, month.... |

`test` 表存放的数据有：

![1](https://img4.mukewang.com/5ba87186000127b819201080.jpg)

可以看到数据是先按照 `RowKey` 进行排序的，然后对于 `RowKey` 相同的行再根据 `Column` 进行排序。

## Hbase 建表解析

下面有一个建表语句：

```
create 'demo:user', {NAME => 'b', VERSIONS => '3', COMPRESSION => 'SNAPPY', COMPRESSION_COMPACT => 'SNAPPY', REPLICATION_SCOPE => 1}, {NAME => 'o', REPLICATION_SCOPE => 1, COMPRESSION => 'SNAPPY', COMPRESSION_COMPACT => 'SNAPPY'}

create 'demo:user', {NAME => 'b', VERSIONS => '3'REPLICATION_SCOPE => 1}, {NAME => 'o', REPLICATION_SCOPE => 1}
```
